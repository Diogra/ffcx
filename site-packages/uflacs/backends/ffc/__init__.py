
# TODO: Attach form_data.cell to target_formatter for geometry generation?

# TODO: Attach data from ffc to target_formatter for element generation?

# TODO: Move integrate to be a target_formatter property?

def compute_uflacs_integral_ir(ffc_data,
                               itg_data,
                               form_data,
                               parameters):
    # TODO: Just keep it simple now, and adjust the default
    #       formatter to match what we need for ffc
    from uflacs.codeutils.target_formatter import CppDefaultFormatter
    target_formatter = CppDefaultFormatter()
    target_formatter.form_argument_mapping = form_data.function_replace_map

    #domain_type = itg_data.domain_type # TODO: Use this
    #cell = form_data.cell # TODO: Use this

    assert len(itg_data.integrals) == 1
    integrand = itg_data.integrals[0].integrand()

    from uflacs.backends.cpp2.compiler import compute_expression_body_ir
    uir = compute_expression_body_ir(integrand,
                                     target_formatter,
                                     integrate=True)
    return uir

def optimize_integral_ir(ir, parameters):
    # TODO: Implement some optimization here!
    oir = ir
    return oir

def generate_tabulate_tensor_code(ir, parameters):

    # Use generic compiler routine to compile expression body
    from uflacs.backends.cpp2.compiler import generate_expression_body_code
    code = generate_expression_body_code(ir)

    # Format uflacs specific code structure into a single string
    from uflacs.codeutils.format_code_structure import format_code_structure
    code = format_code_structure(code)
    return code
