
import unittest
from ufl.classes import Terminal, Operator

class UflTestCase(unittest.TestCase):
    """Wrapper around unittest.TestCase to backport some
    assertions from python 2.7 and add some ufl specific ones."""
    def setUp(self):
        super(UflTestCase, self).setUp()

    def tearDown(self):
        super(UflTestCase, self).tearDown()

    ### Asserts available in TestCase from python 2.7:

    def _assertIsInstance(self, obj, cl, msg=None):
        self.assertTrue(isinstance(obj, cl), msg=None)

    def _assertNotIsInstance(self, obj, cl, msg=None):
        self.assertFalse(isinstance(obj, cl), msg=msg)

    def _assertIs(self, obj, cl, msg=None):
        self.assertTrue(obj is cl, msg=None)

    def _assertIsNot(self, obj, cl, msg=None):
        self.assertTrue(obj is not cl, msg=msg)

    def _assertIsNone(self, obj, msg=None):
        self.assertTrue(obj is None, msg=msg)

    ### UFL specific asserts

    def assertSameIndices(self, expr, free_indices, msg=None):
        self.assertEqual(expr.free_indices(), free_indices, msg=msg)

    def assertSameShape(self, expr, shape, msg=None):
        self.assertEqual(expr.shape(), shape, msg=msg)

    def assertSameExprProps(self, expr, shape=None, free_indices=None, terminal=None, msg=None):
        if shape is not None:
            self.assertSameShape(expr, shape, msg=msg)
        if free_indices is not None:
            self.assertSameIndices(expr, free_indices, msg=msg)
        if terminal is not None:
            if terminal:
                self.assertIsInstance(expr, Terminal, msg=msg)
            else:
                self.assertIsInstance(expr, Operator, msg=msg)

    ### Utilities for optional integration testing with dolfin

    def require_dolfin(self):
        try:
            import dolfin
            return dolfin
        except:
            self.skipTest("Failed to import dolfin.")

# Hack for different versions of python unittest:
for func in ('assertIsInstance', 'assertNotIsInstance', 'assertIs', 'assertIsNot', 'assertIsNone'):
    if not hasattr(UflTestCase, func):
        setattr(UflTestCase, func, getattr(UflTestCase, '_'+func))

